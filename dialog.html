<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; font-family: Arial, sans-serif; }
        .container { max-width: 400px; margin: auto; }
        .input-field label { font-size: 14px; }
        .btn { width: 100%; margin-top: 15px; }
        #livreurField { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h5 class="center-align">SÃ©lectionnez une occasion</h5>

    <!-- Hidden field to store the action type -->
    <input type="hidden" id="actionType" value="<?= action ?>">

    <!-- Occasion Selection -->
    <div class="input-field">
        <select id="occasionSelect">
            <? for (var i = 0; i < occasions.length; i++) { ?>
                <option value="<?= occasions[i] ?>" <?= i === 0 ? 'selected' : '' ?>><?= occasions[i] ?></option>
            <? } ?>
        </select>
        <label>Occasion</label>
    </div>

    <!-- Livreur ID Field (initially hidden) -->
    <div id="livreurField" class="input-field">
        <input type="text" id="livreurId">
        <label for="livreurId">ID du livreur</label>
    </div>

    <!-- Date Selection -->
    <div class="input-field">
        <input type="date" id="dateLivraison">
        <label for="dateLivraison">Date de livraison</label>
    </div>

    <!-- Submit Button -->
    <button class="btn waves-effect waves-light blue" onclick="handleSubmit()">
        Valider
    </button>
</div>

<!-- Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize form selects
        M.FormSelect.init(document.querySelectorAll('select'));

        // Set default date to today
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('dateLivraison').value = today;

        // Show/hide livreur field based on action type
        const livreurField = document.getElementById('livreurField');
        const actionType = document.getElementById('actionType').value;

        if (actionType === 'notify' || actionType === 'generate') {
            livreurField.style.display = 'block';
        }
    });

    function handleSubmit() {
        let action = document.getElementById("actionType").value;
        let occasion = document.getElementById("occasionSelect").value;
        let dateLivraison = document.getElementById("dateLivraison").value;
        let livreurId = document.getElementById("livreurId") ? document.getElementById("livreurId").value : '';

        // Validation
        if (!occasion || !dateLivraison) {
            M.toast({html: "Veuillez remplir tous les champs", classes: "red"});
            return;
        }

        // Additional validation for notify and generate actions
        if ((action === "notify" || action === "generate") && !livreurId) {
            M.toast({html: "Veuillez saisir l'ID du livreur", classes: "red"});
            return;
        }

        // Call appropriate function based on action
        if (action === "notifyAll") {
            google.script.run.notifyAllLivreurs(occasion, dateLivraison);
        } else if (action === "notify") {
            google.script.run.notifyLivreur(livreurId, occasion, dateLivraison);
        } else if (action === "generateAll") {
            google.script.run.generateAllDeliveryDoc(occasion, dateLivraison);
        } else if (action === "generate") {
            google.script.run.generateDeliveryDoc(livreurId, occasion, dateLivraison);
        }

        google.script.host.close();
    }
</script>

</body>
</html>